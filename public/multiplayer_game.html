<!doctype html>
<html lang="en">
  <head>
    <title>WWWordle</title>
    <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="/css/prod.css" rel="stylesheet">
  </head>
  <body>
    <script src="/js/game_box.js"></script>
    <script src="/js/keyboard.js"></script>
    <script src="/js/players_list.js"></script>
    <script src="/js/multiplayer_control.js"></script>

    <div class="flex flex-col justify-center items-center font-sans m-4">
      <div class="flex flex-col px-1 py-1 max-w-sm w-full">
        <div id="game_box"></div>
        <div class="flex">
          <div id="players_list"></div>
          <div id="start_game" class="flex"></div>
        </div>
      </div>
      <div class="flex flex-col m-2 max-w-sm w-full">
        <div class="my-2 w-full max-w-sm">
          <div class="my-2 flex">
            <input class="flex-1 rounded border text-ellipsis" id="game_id" readonly></input>
            <button id="copy" class="rounded border px-1 py-1 bg-blue-600 text-gray-50" >Copy game link</button>
          </div>
        </div>
        <form action="/new" method="get" class="bg-transparent flex justify-center">
          <input name="mode" hidden value="time_competition"/>
          <input name="dictionary" hidden value="en"/>
          <button class="inline-flex items-center px-1 py-1 border border-transparent text-base rounded text-gray-50 bg-green-600 hover:bg-green-700">
            New üèÅ
          </button>
        </form>
      </div>
    </div>
      <script src="/js/board.js"></script>
      <script>
        var game_id = location.pathname.split('/')[2];
        var saved_state = localStorage.getItem(game_id);

        var state = null;
        if(saved_state) {
          state = JSON.parse(saved_state);
        }else {
          state = {
            game_id: game_id,
            player_id: null,
            game: {attempts: [], status: 'in_progress'},
            status: 'offline',
            notify: '',
            players: [],
            start_game_time: null,
            end_game_time: null,
            dictionary_name: "en"
          }
        };

        function save_state() {
          localStorage.setItem(game_id, JSON.stringify(state));
        }

        function get_player_by_id(id) {
          return state.players.find(player => player.id == id);
        }

        var connect = function () {
          var gameSocket = new WebSocket("ws://" + location.host);

          gameSocket.onopen = function (event) {
            gameSocket.send(JSON.stringify({
              type: 'join',
              game_id: game_id,
              player_id: state.player_id,
              channel: 'multiplayer'
            }));
          };

          gameSocket.onclose = function (event) {
            ReactDOM.render(React.createElement(GameBox, {
              game: state.game,
              onWordSubmit: onWordSubmit,
              game_language: state.dictionary_name,
              status: 'offline',
              notify_message: 'Disconnected'}), document.getElementById('game_box')
            )

            save_state();

            setTimeout(function () {
              // gameSocket.removeAllListeners();
              connect();
            }, 1000);
          }

          gameSocket.onmessage = function (event) {
            console.log(event.data);
            var payload = JSON.parse(event.data);

            if(payload.status == 'ok') {
              if(payload.type == "join") {
                state.players =  payload.data.players;
                state.player_id = payload.data.player_id;
                state.dictionary_name = payload.data.dictionary_name;
                // TODO: use server side rendering
                document.getElementsByName("dictionary")[0].setAttribute('value', state.dictionary_name);
              }else if(payload.type == "attempt") {
                 if(payload.data.attempt_result == 'word_found'){
                  state.game = payload.data.game;
                  state.notify = 'Go on!';
                }else if(payload.data.attempt_result == 'word_not_available'){
                  state.notify = 'Word is not available!';
                }else if(payload.data.attempt_result == 'won'){
                  state.game = payload.data.game;
                  state.notify = 'You win!';
                }else if(payload.data.attempt_result == 'lost'){
                  state.game = payload.data.game;
                  state.notify = 'You will definitely win next time!';
                }
              }
            }else if(payload.notify_type == 'game_started') {
              state.notify = 'Game has started! The fastest one wins!';
              state.start_game_time = Date.parse(payload.data.start_time);
            }else if(payload.notify_type == 'game_ended') {
              var player = get_player_by_id(payload.data.winner_id);
              state.end_game_time = Date.parse(payload.data.end_time);
              var duration = (state.end_game_time - state.start_game_time) / 1000;
              state.notify = 'Game ended in ' + duration + ' seconds! Winner: ' + player.name + '!!!';
              state.winner_id = player.id;
            }else if(payload.notify_type == 'player_joined'){
              state.players.push(payload.data.player);
            }else if(payload.notify_type == 'player_ended_game'){
              var player = get_player_by_id(payload.data.player_id);
              player["last_match"] = payload.data.match;

              state.notify = player.name + ' has ended the game!';
            } else if(payload.notify_type == 'player_found_word') {
              var player = get_player_by_id(payload.data.player_id);
              player["last_match"] = payload.data.match
              state.notify = player.name + ' entered a word!';
            }else if(payload.status == 'error'){
              state.notify = payload.data.message;
            }

              ReactDOM.render(React.createElement(GameBox, {
                        game: state.game,
                        onWordSubmit: onWordSubmit,
                        status: 'online',
                        game_language: state.dictionary_name,
                        notify_message: state.notify}), document.getElementById('game_box'));

              ReactDOM.render(React.createElement(PlayersList, {
                players: state.players,
                winner_id: state.winner_id,
                current_player_id: state.player_id,
              }), document.getElementById('players_list'))

              ReactDOM.render(React.createElement(MultiplayerControl, {
                        onClick: onStartGame,
                        started_at: state.start_game_time}), document.getElementById('start_game'));
            save_state();
          }

          return gameSocket;
        };

        var onWordSubmit = function(word) {
          gameSocket.send(JSON.stringify({
            channel: 'multiplayer',
            player_id: state.player_id,
            game_id: state.game_id,
            type: 'attempt',
            word: word
          }));
        }

        var onStartGame = function() {
          gameSocket.send(JSON.stringify({
            channel: 'multiplayer',
            player_id: state.player_id,
            game_id: state.game_id,
            type: 'start'
          }));
        }

        ReactDOM.render(React.createElement(GameBox, {
          game: state.game,
          onWordSubmit: onWordSubmit,
          game_language: state.dictionary_name,
          status: 'offline'}), document.getElementById('game_box'));

        ReactDOM.render(React.createElement(PlayersList, {
                  players: state.players,
                }), document.getElementById('players_list'))

        ReactDOM.render(React.createElement(MultiplayerControl, {
                  onClick: onStartGame,
                  started_at: state.start_game_time}), document.getElementById('start_game'));

        var gameSocket = connect();

        document.getElementById('game_id').value = location;

        var copy_input = document.getElementById('copy');
        copy_input.addEventListener('click', function (event) {
          document.getElementById('game_id').select();
          document.execCommand('copy');
        });
      </script>
  </body>
</html>

