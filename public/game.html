<!doctype html>
<html lang="en">
  <head>
    <title>WWWordle</title>
    <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href=/css/main.css rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body>
    <script src="/js/name_modal.js"></script>
    <script src="/js/game_box.js"></script>
    <script src="/js/keyboard.js"></script>

    <div class="flex flex-col justify-center items-center font-sans m-4">
      <div id="game_box" class="max-w-sm w-full"></div>
      <div class="flex flex-col m-2">
        <div class="my-2 w-full max-w-sm">
          <div class="my-2 flex">
            <input class="flex-1 rounded border text-ellipsis" id="game_id" readonly></input>
            <button id="copy" class="rounded border px-1 py-1 bg-blue-600 text-gray-50" >Copy game link</button>
          </div>
        </div>
        <form action="/new" method="get" class="bg-transparent flex justify-center">
          <input name="mode" hidden value="coop"/>
          <button class="inline-flex items-center px-1 py-1 border border-transparent text-base rounded text-gray-50 bg-green-600 hover:bg-green-700">
            New ü§ù
          </button>
        </form>
      </div>
    </div>
      <script src="/js/board.js"></script>
      <script>
        var game_id = location.pathname.split('/')[2];
        var state = {
          game_id: game_id,
          game: {attempts: [], status: 'in_progress'},
          status: 'offline',
          notify: '',
        };

        var connect = function () {
          var gameSocket = new WebSocket("ws://" + location.host);

          gameSocket.onopen = function (event) {
            gameSocket.send(JSON.stringify({
              type: 'join',
              game_id: game_id,
              channel: 'game'
            }));
          };

          gameSocket.onclose = function (event) {
            ReactDOM.render(React.createElement(GameBox, {
              game: state.game,
              onWordSubmit: onWordSubmit,
              status: 'offline',
              notify_message: 'Disconnected'}), document.getElementById('game_box')
            )
            setTimeout(function () {
              connect();
            }, 1000);
          }

          gameSocket.onmessage = function (event) {
            console.log(event.data);
            var payload = JSON.parse(event.data);

            if(payload.status == 'ok') {
              if(payload.type == 'join'){
                state.status = 'online';
                state.game = payload.data.game;
              }else if(payload.type == 'attempt'){
                 if(payload.data.attempt_result == 'word_found'){
                  state.game = payload.data.game;
                  state.notify = 'Go on!';
                }else if(payload.data.attempt_result == 'word_not_available'){
                  state.notify = 'Word is not available!';
                }else if(payload.data.attempt_result == 'won'){
                  state.game = payload.data.game;
                  state.notify = 'You win!';
                }else if(payload.data.attempt_result == 'lost'){
                  state.game = payload.data.game;
                  state.notify = 'You will definitely win next time!';
                }
             }
            }else if(payload.notify_type == 'game_updated'){
              state.game = payload.data.game;
              state.notify = 'Someone has added the word!';
            }else if(payload.status == 'error'){
              state.notify = payload.data.message;
            }
            ReactDOM.render(React.createElement(GameBox, {
                      game: state.game,
                      onWordSubmit: onWordSubmit,
                      status: state.status,
                      notify_message: state.notify}), document.getElementById('game_box'));
          }

          return gameSocket;
        };

        var onWordSubmit = function(word) {
          gameSocket.send(JSON.stringify({
            game_id: game_id,
            type: 'attempt',
            word: word,
            channel: 'game'
          }));
        }

        ReactDOM.render(React.createElement(GameBox, {
          game: state.game,
          onWordSubmit: onWordSubmit,
          status: 'offline'}), document.getElementById('game_box'));

        var gameSocket = connect();

        document.getElementById('game_id').value = location;

        var copy_input = document.getElementById('copy');
        copy_input.addEventListener('click', function (event) {
          document.getElementById('game_id').select();
          document.execCommand('copy');
        });
      </script>
  </body>
</html>

