<!doctype html>
<html lang="en">
  <head>
    <title>WWWordle</title>
    <script src="https://unpkg.com/react@17/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js" crossorigin></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body>
    <script src="/js/game_box.js"></script>
    <script src="/js/keyboard.js"></script>

    <div class="flex flex-col justify-center items-center font-sans m-4">
      <div id="game_box"></div>
      <div class="my-2 w-full max-w-sm">
        <label class="inline-block text" for="game_id">Play together:</label>
        <div class="my-2 flex">
          <input class="flex-1 rounded border text-ellipsis" id="game_id" readonly></input>
          <button id="copy" class="rounded border px-1 py-1 bg-blue-600 text-gray-50" >Copy</button>
        </div>
      </div>
      <form action="/new" method="post" class="bg-transparent flex justify-center">
        <button class="inline-flex items-center px-3 py-1 border border-transparent text-base font-medium rounded-md text-gray-50 bg-green-600 hover:bg-green-700">
          Start a new game
        </button>
      </form>
    </div>
      <script src="/js/board.js"></script>
      <script>
        var game_id = location.pathname.split('/')[2];
        var last_game = {attempts: [], status: 'offline'};

        var connect = function () {
          var gameSocket = new WebSocket("ws://" + location.host);

          gameSocket.onopen = function (event) {
            gameSocket.send(JSON.stringify({
              type: 'join',
              game_id: game_id
            }));
          };
          gameSocket.onclose = function (event) {
            ReactDOM.render(React.createElement(GameBox, {
              game: last_game,
              onWordSubmit: onWordSubmit,
              status: 'offline',
              notify_message: 'Disconnected'}), document.getElementById('game_box')
            )
            setTimeout(function () {
              gameSocket.removeAllListeners();
              connect();
            }, 1000);
          }
          gameSocket.onmessage = function (event) {
            console.log(event.data);
            var data = JSON.parse(event.data);

            var gameStatusElement = document.getElementById('game_status');

            if(data.status == 'ok') {
              last_game = data.message.game;

              ReactDOM.render(React.createElement(GameBox, {
                game: data.message.game,
                onWordSubmit: onWordSubmit,
                status: 'online'}), document.getElementById('game_box'));
            }else{

              ReactDOM.render(React.createElement(GameBox, {
                game: last_game,
                onWordSubmit: onWordSubmit,
                status: (data.message == 'Word not found' ? 'online' : 'offline'),
                notify_message: data.message}), document.getElementById('game_box'));
            }
          }

          return gameSocket;
        };

        var onWordSubmit = function(word) {
          gameSocket.send(JSON.stringify({
            game_id: game_id,
            type: 'attempt',
            word: word
          }));
        }

        ReactDOM.render(React.createElement(GameBox, {
          game: last_game,
          onWordSubmit: onWordSubmit,
          status: 'offline'}), document.getElementById('game_box'));

        var gameSocket = connect();

        document.getElementById('game_id').value = location;

        var copy_input = document.getElementById('copy');
        copy_input.addEventListener('click', function (event) {
          document.getElementById('game_id').select();
          document.execCommand('copy');
        });
      </script>
  </body>
</html>

